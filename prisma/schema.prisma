// This is your Prisma schema file for MirzaBot
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ─── User ────────────────────────────────────────────
model User {
  id                  Int       @id @default(autoincrement())
  chatId              BigInt    @unique @map("chat_id")
  username            String?   @db.VarChar(255)
  firstName           String?   @map("first_name") @db.VarChar(255)
  phoneNumber         String?   @map("phone_number") @db.VarChar(20)
  balance             Decimal   @default(0) @db.Decimal(12, 2)
  isVerified          Boolean   @default(false) @map("is_verified")
  userStatus          UserStatus @default(ACTIVE) @map("user_status")
  step                String    @default("home") @db.VarChar(100)
  refCode             String    @unique @default(cuid()) @db.VarChar(50) @map("ref_code")
  referredBy          BigInt?   @map("referred_by")
  affiliateCount      Int       @default(0) @map("affiliate_count")
  rollAccepted        Boolean   @default(false) @map("roll_accepted")
  limitUserTest       Int       @default(0) @map("limit_user_test")
  messageCount        Int       @default(0) @map("message_count")
  lastMessageTime     Int       @default(0) @map("last_message_time")
  descriptionBlocking String?   @map("description_blocking") @db.Text
  processingValue     String    @default("0") @map("processing_value") @db.VarChar(500)
  processingValueOne  String    @default("0") @map("processing_value_one") @db.VarChar(500)
  processingValueTwo  String    @default("0") @map("processing_value_two") @db.VarChar(500)
  processingValueThree String   @default("0") @map("processing_value_three") @db.VarChar(500)
  processingValueFour String    @default("0") @map("processing_value_four") @db.VarChar(100)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  invoices        Invoice[]
  paymentReports  PaymentReport[]
  supportTickets  SupportTicket[]

  @@map("users")
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

// ─── Admin ───────────────────────────────────────────
model Admin {
  id        Int       @id @default(autoincrement())
  chatId    BigInt    @unique @map("chat_id")
  role      AdminRole @default(ADMIN)
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SALES
  SUPPORT
}

// ─── Panel (6 نوع پنل) ──────────────────────────────
model Panel {
  id              Int        @id @default(autoincrement())
  name            String     @unique @db.VarChar(255)
  type            PanelType
  url             String     @db.VarChar(500)
  username        String     @db.VarChar(255)
  password        String     @db.VarChar(255)
  status          PanelStatus @default(ACTIVE)
  inbounds        String?    @db.Text
  inboundId       String?    @map("inbound_id") @db.VarChar(200)
  methodUsername  UsernameMethod @default(RANDOM) @map("method_username")
  onHoldEnabled   Boolean    @default(false) @map("on_hold_enabled")
  dateLogin       String?    @map("date_login") @db.Text
  createdAt       DateTime   @default(now()) @map("created_at")

  products  Product[]
  invoices  Invoice[]

  @@map("panels")
}

enum PanelType {
  MARZBAN
  MARZNESHIN
  X_UI
  S_UI
  WGDASHBOARD
  MIKROTIK
}

enum PanelStatus {
  ACTIVE
  INACTIVE
}

enum UsernameMethod {
  RANDOM
  CUSTOM_RANDOM
  CUSTOM_ONLY
  CHAT_ID_RANDOM
  CHAT_ID_ONLY
}

// ─── Product ─────────────────────────────────────────
model Product {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  price       Decimal  @db.Decimal(12, 2)
  volume      Int
  duration    Int
  panelId     Int      @map("panel_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  panel     Panel     @relation(fields: [panelId], references: [id])
  invoices  Invoice[]

  @@map("products")
}

// ─── Invoice (جدول اصلی خرید) ────────────────────────
model Invoice {
  id              Int           @id @default(autoincrement())
  userId          Int           @map("user_id")
  productId       Int           @map("product_id")
  panelId         Int           @map("panel_id")
  username        String        @db.VarChar(255)
  configUrl       String?       @map("config_url") @db.Text
  subscriptionUrl String?       @map("subscription_url") @db.Text
  serviceLocation String        @map("service_location") @db.VarChar(255)
  productName     String        @map("product_name") @db.VarChar(255)
  productPrice    Decimal       @map("product_price") @db.Decimal(12, 2)
  status          InvoiceStatus @default(ACTIVE)
  expiresAt       DateTime?     @map("expires_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  panel   Panel   @relation(fields: [panelId], references: [id])

  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  ACTIVE
  END_OF_TIME
  END_OF_VOLUME
  SENDEDWARN
  WARNED
  DISABLED
  REMOVED
  REMOVE_TIME
}

// ─── PaymentReport (گزارش پرداخت‌ها) ─────────────────
model PaymentReport {
  id              Int           @id @default(autoincrement())
  userId          Int           @map("user_id")
  orderId         String        @unique @map("order_id") @db.VarChar(100)
  amount          Decimal       @db.Decimal(12, 2)
  method          PaymentMethod
  status          PaymentStatus @default(PENDING)
  transactionId   String?       @map("transaction_id") @db.VarChar(255)
  description     String?       @db.Text
  photoId         String?       @map("photo_id") @db.VarChar(500)
  createdAt       DateTime      @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("payment_reports")
}

enum PaymentMethod {
  CARD_TO_CARD
  NOWPAYMENTS
  AQAYE_PARDAKHT
  DIGI_PAY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ─── SupportTicket ───────────────────────────────────
model SupportTicket {
  id        Int          @id @default(autoincrement())
  userId    Int          @map("user_id")
  message   String       @db.Text
  response  String?      @db.Text
  status    TicketStatus @default(OPEN)
  createdAt DateTime     @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("support_tickets")
}

enum TicketStatus {
  OPEN
  ANSWERED
  CLOSED
}

// ─── BotText (متون قابل تنظیم) ───────────────────────
model BotText {
  id    Int    @id @default(autoincrement())
  key   String @unique @db.VarChar(100)
  value String @db.Text

  @@map("bot_texts")
}

// ─── HelpItem (آیتم‌های راهنما) ───────────────────────
model HelpItem {
  id      Int    @id @default(autoincrement())
  title   String @db.VarChar(255)
  content String @db.Text
  fileId  String? @map("file_id") @db.VarChar(500)
  sortOrder Int  @default(0) @map("sort_order")

  @@map("help_items")
}

// ─── Channel (عضویت اجباری) ──────────────────────────
model Channel {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  chatId    String   @map("chat_id") @db.VarChar(100)
  link      String   @db.VarChar(200)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("channels")
}

// ─── Affiliate (تنظیمات زیرمجموعه‌گیری) ──────────────
model AffiliateSetting {
  id              Int     @id @default(autoincrement())
  isEnabled       Boolean @default(false) @map("is_enabled")
  discountEnabled Boolean @default(false) @map("discount_enabled")
  rewardAmount    Decimal @default(0) @map("reward_amount") @db.Decimal(12, 2)
  discountPercent Int     @default(0) @map("discount_percent")

  @@map("affiliate_settings")
}

// ─── DiscountCode (کدهای تخفیف) ──────────────────────
model DiscountCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique @db.VarChar(100)
  percent     Int
  maxUses     Int      @default(1) @map("max_uses")
  usedCount   Int      @default(0) @map("used_count")
  isActive    Boolean  @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("discount_codes")
}

// ─── Protocol (پروتکل‌های VPN) ────────────────────────
model Protocol {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(100)

  @@map("protocols")
}

// ─── BotSetting (تنظیمات کلی ربات) ───────────────────
model BotSetting {
  id                  Int     @id @default(autoincrement())
  botStatus           Boolean @default(true) @map("bot_status")
  verifyRequired      Boolean @default(false) @map("verify_required")
  rulesRequired       Boolean @default(false) @map("rules_required")
  phoneRequired       Boolean @default(false) @map("phone_required")
  iranOnlyPhone       Boolean @default(false) @map("iran_only_phone")
  helpEnabled         Boolean @default(false) @map("help_enabled")
  testAccountLimit    Int     @default(0) @map("test_account_limit")
  removeDaysAfterExp  Int     @default(7) @map("remove_days_after_exp")
  messageLimitPerMin  Int     @default(10) @map("message_limit_per_min")
  reportChannelId     String? @map("report_channel_id") @db.VarChar(100)
  cardNumber          String? @map("card_number") @db.VarChar(50)
  nowPaymentsEnabled  Boolean @default(false) @map("nowpayments_enabled")
  digiPayEnabled      Boolean @default(false) @map("digipay_enabled")
  aqayePardakhtEnabled Boolean @default(false) @map("aqaye_pardakht_enabled")
  cardToCardEnabled   Boolean @default(true) @map("card_to_card_enabled")

  @@map("bot_settings")
}
